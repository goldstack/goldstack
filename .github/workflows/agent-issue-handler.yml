name: Agent Issue Handler

on:
  issues:
    types: [opened, reopened]

jobs:
  run-agent:
    if: startsWith(github.event.issue.title, 'Agent:') && (github.event.issue.user.login == 'mxro' || github.event.issue.user.login == 'goldstack')
    name: Run Agent for Issue by authorized user
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Debug Issue Info
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_USER_LOGIN: ${{ github.event.issue.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        shell: bash
        run: |
          set -euo pipefail
          printf 'Issue Title: %s\n' "$ISSUE_TITLE"
          printf 'Issue User Login: %s\n' "$ISSUE_USER_LOGIN"
          printf 'Issue Number: %s\n' "$ISSUE_NUMBER"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      - uses: ./.github/actions/goldstack-setup

      - name: Install Cline CLI
        run: npm install -g cline@1.0.8

      - name: Configure Cline
        run: |
          cline auth --provider openrouter --apikey ${{ secrets.OPENROUTER_API_KEY }} --modelid deepseek/deepseek-v3.2

      - name: Extract task from issue
        id: issue
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        shell: bash
        run: |
          set -euo pipefail

          TITLE="$ISSUE_TITLE"
          BODY="$ISSUE_BODY"

          # Normalize body AFTER assigning safely from env.
          BODY=$(printf '%s' "$BODY" | sed 's|\\|/|g; s/\r$//g' | tr -d '\000-\031' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          SHORT_TASK="${TITLE#Agent: }"
          # Ensure the short task is always a single line (safe for commit/PR titles).
          SHORT_TASK=$(printf '%s' "$SHORT_TASK" | tr -d '\r\n' | tr -d '\000-\031' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          FULL_TASK="${SHORT_TASK}"$'\n\n'"${BODY}"$'\n\n'"Please consult AGENTS.md for project guidelines and coding standards before making changes."

          printf 'task=%s\n' "$SHORT_TASK" >> "$GITHUB_OUTPUT"

          # Multiline-safe output.
          {
            echo 'full_task<<EOF'
            printf '%s\n' "$FULL_TASK"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Run Cline agent
        env:
          FULL_TASK: ${{ steps.issue.outputs.full_task }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Running Cline with task:"
          printf '%s\n' "$FULL_TASK"
          cline -y "$FULL_TASK"

      - name: Create branch and push
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          TASK: ${{ steps.issue.outputs.task }}
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="agent-issue-$ISSUE_NUMBER"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "Agent: $TASK" || exit 0
          git push origin "$BRANCH"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          TASK: ${{ steps.issue.outputs.task }}
        shell: bash
        run: |
          set -euo pipefail
          PR_URL=$(gh pr create \
            --title "Agent: $TASK" \
            --body "From issue #$ISSUE_NUMBER" \
            --head "agent-issue-$ISSUE_NUMBER")
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ¤– PR created: $PR_URL"
