name: Build, Test and Library Publish

on:
  push:
    branches:
      - master

jobs:
  setup:
    name: 'Setup Environment'
    if: ${{ ! contains(github.event.head_commit.message, 'ci_skip') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Goldstack repo
        uses: actions/checkout@25a956c84d5dd820d28caab9f86b8d183aeeff3d
        with:
          fetch-depth: 20
          token: ${{secrets.BUILD_TOKEN}}
      - uses: actions/setup-node@v2
        with:
          node-version: '20'
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '20'
      - name: Configure git
        run: |
          git config --global user.email "goldstack@pureleap.com"
          git config --global user.name "Goldstack Project Builder"
          git config --global pull.rebase false
      - name: Install Yarn
        run: npm install -g yarn@1.22.11
      - name: Configure yarn
        run: 'yarn config set --home --json npmRegistries ''{ "//registry.npmjs.org": { "npmAuthToken": "''"${{secrets.NPM_TOKEN}}"''" } }'''
      - name: Install dependencies
        run: yarn install
      - name: Cache workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}

  lint-and-audit:
    needs: setup
    name: 'Lint and Audit'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Format and Lint
        run: |
          yarn format
          yarn format-check
          yarn lint-fix
      - name: NPM Audit
        run: |
          yarn npm audit --all --recursive --severity critical

  detect-changes:
    needs: setup
    name: 'Detect Changes'
    runs-on: ubuntu-latest
    outputs:
      changed-utilities: ${{ steps.changed-utilities.outputs.changed }}
      changed-libs: ${{ steps.changed-libs.outputs.changed }}
      changed-templates: ${{ steps.changed-templates.outputs.changed }}
      changed-mgmt: ${{ steps.changed-mgmt.outputs.changed }}
      changed-apps: ${{ steps.changed-apps.outputs.changed }}
      changed-docs: ${{ steps.changed-docs.outputs.changed }}
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Check if utilities changed
        uses: marceloprado/has-changed-path@8a75b456df5a44a8110dcaa3111c9acc6249ed15
        id: changed-utilities
        with:
          paths: .
        env:
          SOURCE: workspaces/utils
      - name: Check if libraries changed
        uses: marceloprado/has-changed-path@8a75b456df5a44a8110dcaa3111c9acc6249ed15
        id: changed-libs
        with:
          paths: .
        env:
          SOURCE: workspaces/templates-lib
      - name: Check if templates changed
        uses: marceloprado/has-changed-path@8a75b456df5a44a8110dcaa3111c9acc6249ed15
        id: changed-templates
        with:
          paths: .
        env:
          SOURCE: workspaces/templates
      - name: Check if template management changed
        uses: marceloprado/has-changed-path@8a75b456df5a44a8110dcaa3111c9acc6249ed15
        id: changed-mgmt
        with:
          paths: .
        env:
          SOURCE: workspaces/templates-management
      - name: Check if apps changed
        uses: marceloprado/has-changed-path@8a75b456df5a44a8110dcaa3111c9acc6249ed15
        id: changed-apps
        with:
          paths: .
        env:
          SOURCE: workspaces/apps
      - name: Check if docs changed
        uses: marceloprado/has-changed-path@8a75b456df5a44a8110dcaa3111c9acc6249ed15
        id: changed-docs
        with:
          paths: .
        env:
          SOURCE: workspaces/docs

  compile:
    needs: [lint-and-audit, detect-changes]
    name: 'Compile'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Compile all
        run: yarn compile

  test-utilities:
    needs: compile
    name: 'Test Utilities'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Test utilities
        run: |
          cd workspaces/utils
          yarn test
          cd ../..

  test-libraries:
    needs: compile
    name: 'Test Libraries'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Test libraries
        run: |
          cd workspaces/templates-lib
          yarn test
          cd ../..

  test-templates:
    needs: compile
    name: 'Test Templates'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Test templates
        run: |
          cd workspaces/templates
          yarn test
          cd ../..
        env:
          AWS_USER_NAME: goldstack-dev
          AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_DEFAULT_REGION: us-west-2

  test-template-management:
    needs: compile
    name: 'Test Template Management'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Test template management
        run: |
          cd workspaces/templates-management
          yarn test
          cd ../..

  test-apps:
    needs: compile
    name: 'Test Apps'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Test apps
        run: |
          cd workspaces/apps
          yarn workspace @goldstack/goldstack-api seed-templates
          yarn test
          cd ../..
        env:
          AWS_USER_NAME: goldstack-dev
          AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_DEFAULT_REGION: us-west-2

  test-docs:
    needs: compile
    name: 'Test Docs'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Test docs
        run: |
          cd workspaces/docs
          yarn test
          cd ../..
        env:
          AWS_USER_NAME: goldstack-dev
          AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_DEFAULT_REGION: us-west-2

  generate:
    needs: [test-utilities, test-libraries, test-templates, test-template-management, test-apps, test-docs]
    name: 'Generate Schemas and Docs'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Generate schemas
        run: yarn generate-schema
      - name: Generate docs
        run: yarn generate-docs
      - name: Commit changes
        run: |
          git status
          git add .
          git status
          git diff-index --quiet HEAD || git commit -m "Updates from build pipeline (ci_skip)"
          git status

  publish:
    needs: [generate, detect-changes]
    name: 'Publish Libraries'
    if: ${{ (needs.detect-changes.outputs.changed-libs == 'true' || needs.detect-changes.outputs.changed-utilities == 'true') && github.ref == 'refs/heads/master' }}
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Publish utilities and libraries
        run: |
          cd workspaces/utils
          yarn version:apply --deferred patch
          cd ../..
          cd workspaces/templates-lib
          yarn version:apply --deferred patch
          cd ../.. 

          yarn version apply --all
          cd workspaces/utils
          yarn publish
          git status
          git add .
          cd ../..
          cd workspaces/templates-lib
          yarn publish
          git status
          git add .
          cd ../..
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
          YARN_NPM_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
      - name: Push changes
        uses: ad-m/github-push-action@65392840bda2e774394d5cd38ca33e5918aec2d3
        with:
          github_token: ${{secrets.BUILD_TOKEN}}
      - name: Write current git commit
        run: |
          echo "Writing git commit hash to output $(git rev-parse HEAD)"
          git rev-parse HEAD
          echo "::set-output name=patchedcommit::$(git rev-parse HEAD)"

  cleanup-and-deploy:
    needs: [publish, generate]
    if: always() && github.ref == 'refs/heads/master'
    name: 'Cleanup and Deploy'
    runs-on: ubuntu-latest
    steps:
      - name: Restore workspace
        uses: actions/cache@v2
        with:
          path: .
          key: ${{ github.sha }}
      - name: Remove yarn secret
        run: 'yarn config set --home --json npmRegistries ''{ "//registry.npmjs.org": { "npmAuthToken": "''""''" } }'''
      - name: Write build date
        run: echo "$(date +'%Y-%m-%dT%H:%M:%S')" >> build_dev_timestamp
      - name: Linting and prettier
        run: |
          yarn format
          yarn lint-fix
      - name: Commit latest build info
        run: |
          git add .
          git diff-index --quiet HEAD || git commit -m "GitHub actions build (ci_skip) (trigger_template_deploy_dev)"
          git status
      - name: Push changes
        uses: ad-m/github-push-action@65392840bda2e774394d5cd38ca33e5918aec2d3
        with:
          github_token: ${{secrets.BUILD_TOKEN}}
      - name: Write current git commit
        run: |
          echo "Writing git commit hash to output $(git rev-parse HEAD)"
          git rev-parse HEAD
          echo "::set-output name=patchedclicommit::$(git rev-parse HEAD)"
      - name: Deploy docs
        run: |
          yarn workspace @goldstack/docs-main deploy-ts dev
        env:
          AWS_USER_NAME: goldstack-dev
          AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_DEFAULT_REGION: us-west-2
      - name: Deploy API
        run: |
          yarn workspace @goldstack/goldstack-api deploy-ts dev
        env:
          AWS_USER_NAME: goldstack-dev
          AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_DEFAULT_REGION: us-west-2
          STRIPE_API_KEY: ${{secrets.DEV_STRIPE_PRIVATE_KEY}}
      - name: Deploy UI
        run: |
          yarn workspace @goldstack/goldstack-home deploy-ts dev
        env:
          AWS_USER_NAME: goldstack-dev
          AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
          AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
          AWS_DEFAULT_REGION: us-west-2
