name: kilocode

on:
  release:
    types: [published]
  # issue_comment:
  #   types: [created]
  # pull_request_review_comment:
  #   types: [created]


jobs:
  kilocode:
    if: |
      false &&
      ((contains(github.event.comment.body, '/kilo') ||
       contains(github.event.comment.body, '/kilocode'))
      && (github.event.issue.user.login == 'mxro' || github.event.issue.user.login == 'goldstack'))
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }} # important so we trigger workflows

      - uses: ./.github/actions/goldstack-setup

      - name: Configure git
        run: |
          git config user.name "goldstack"
          git config user.email "goldstack@users.noreply.github.com"

      - name: Install Kilo Code CLI
        run: |
          npm install -g @kilocode/cli

      - name: Configure Kilo Code
        run: |
          mkdir -p ~/.kilocode/cli
          jq '.providers[0].kilocodeToken = "${{ secrets.KILO_API_KEY }}"' .github/workflows/kilocode-config.json > ~/.kilocode/cli/config.json

      - name: Setup gha-agent alias
        run: |
          mkdir -p ~/bin
          echo '#!/bin/bash' > ~/bin/gha_agent
          echo 'exec yarn workspace @goldstack/utils-gha-agent cli "$@"' >> ~/bin/gha_agent
          chmod +x ~/bin/gha_agent
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Run Kilo Code Workflow
        env:
          # Core configuration
          KILO_TELEMETRY: false
          KILO_THEME: dark

          # Provider configuration
          KILO_PROVIDER_TYPE: kilocode
          KILOCODE_TOKEN: ${{ secrets.KILO_API_KEY }}
          KILOCODE_MODEL: x-ai/grok-code-fast-1

          # Auto-approval configuration (non-default values)
          KILO_AUTO_APPROVAL_READ_OUTSIDE: false

          # GitHub integration
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          COMMENT_JSON: ${{ toJson(github.event.comment.body) }}
        run: |
          gha_agent run-all --comment "$COMMENT_JSON" \
            --issue-number ${{ github.event.issue.number }} \
            --timeout 2700 \
            --kilo-provider kilocode \
            --kilo-provider-type kilocode \
            --model x-ai/grok-code-fast-1 \
            --agent-instructions $(pwd)/AGENTS_GHA.md
