name: kilocode

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]


jobs:
  kilocode:
    if: |
      (contains(github.event.comment.body, '/kilo') ||
       contains(github.event.comment.body, '/kilocode'))
      && (github.event.issue.user.login == 'mxro' || github.event.issue.user.login == 'goldstack')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/goldstack-setup

      - run: |
          npm install -g @kilocode/cli

      - name: Setup gha-agent alias
        run: |
          mkdir -p ~/bin
          echo '#!/bin/bash' > ~/bin/gha_agent
          echo 'exec yarn workspace @goldstack/utils-gha-agent cli "$@"' >> ~/bin/gha_agent
          chmod +x ~/bin/gha_agent
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure git
        run: |
          git config user.name "goldstack"
          git config user.email "goldstack@users.noreply.github.com"

      - name: Run Kilo Code Workflow
        env:
          KILO_PROVIDER: kilocode
          KILO_PROVIDER_TYPE: kilocode
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
          KILOCODE_TOKEN: ${{ secrets.KILO_API_KEY }}
          KILOCODE_MODEL: x-ai/grok-code-fast-1
          # KILOCODE_MODEL: minimax/minimax-m2.1:free
          KILO_TELEMETRY_DEBUG: false
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gha_agent run-all --comment "${{ github.event.comment.body }}" --issue-number ${{ github.event.issue.number }}
