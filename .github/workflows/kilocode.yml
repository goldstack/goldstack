name: kilocode

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  kilocode:
    if: |
      (contains(github.event.comment.body, '/kilo') ||
       contains(github.event.comment.body, '/kilocode'))
      && (github.event.issue.user.login == 'mxro' || github.event.issue.user.login == 'goldstack')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: ./.github/actions/goldstack-setup

      - name: Setup gha-agent alias
        run: |
          mkdir -p ~/bin
          echo '#!/bin/bash' > ~/bin/gha_agent
          echo 'exec yarn workspace @goldstack/utils-gha-agent cli "$@"' >> ~/bin/gha_agent
          chmod +x ~/bin/gha_agent
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Configure git
        run: |
          git config user.name "goldstack"
          git config user.email "goldstack@users.noreply.github.com"

      - name: Identify Issue and PR Numbers
        id: identifiers
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
        run: |
          NUM=${{ github.event.issue.number }}
          RESULT=$(gha_agent identify-comment --comment "${{ github.event.comment.body }}" --issue-number "$NUM")
          echo "issue_number=$(echo "$RESULT" | jq -r '.issueNumber // ""')" >> $GITHUB_OUTPUT
          echo "pr_number=$(echo "$RESULT" | jq -r '.prNumber // ""')" >> $GITHUB_OUTPUT

      - name: Identify Branch
        id: branch
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
        run: |
          ISSUE_NUMBER=${{ steps.identifiers.outputs.issue_number }}
          PR_NUMBER=${{ steps.identifiers.outputs.pr_number }}
          RESULT=$(gha_agent identify-branch --issue-number "$ISSUE_NUMBER" ${PR_NUMBER:+"--pr-number" "$PR_NUMBER"})
          echo "name=$(echo "$RESULT" | jq -r '.branchName // ""')" >> $GITHUB_OUTPUT

      - name: Checkout working branch
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
        run: |
          BRANCH="${{ steps.branch.outputs.name }}"
          PR_NUMBER=${{ steps.identifiers.outputs.pr_number }}
          gha_agent checkout-branch --branch-name "$BRANCH" ${PR_NUMBER:+"--pr-number" "$PR_NUMBER"}

      - name: Post start comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ steps.identifiers.outputs.issue_number }}
          PR_NUMBER=${{ steps.identifiers.outputs.pr_number }}
          BRANCH_NAME=${{ steps.branch.outputs.name }}
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          COMMENT=$'ðŸš€ Kilo Code has started working on this task.\n\n'
          COMMENT+=$'- **Branch**: `'"$BRANCH_NAME"'`\n'
          COMMENT+=$'- **Issue**: #'"$ISSUE_NUMBER"' \n'
          [ -n "$PR_NUMBER" ] && COMMENT+=$'- **PR**: #'"$PR_NUMBER"' \n'
          COMMENT+=$'- **Run**: [View workflow]('"$RUN_URL"')\n'
          
          if [ -n "$PR_NUMBER" ]; then
            gh pr comment "$PR_NUMBER" --body "$COMMENT"
          else
            gh issue comment "$ISSUE_NUMBER" --body "$COMMENT"
          fi

      - name: Extract prompt
        id: ctx
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
        run: |
          ISSUE_NUMBER=${{ steps.identifiers.outputs.issue_number }}
          PR_NUMBER=${{ steps.identifiers.outputs.pr_number }}
          RESULT=$(gha_agent build-context \
            --comment "${{ github.event.comment.body }}" \
            --issue-number "$ISSUE_NUMBER" \
            ${PR_NUMBER:+"--pr-number" "$PR_NUMBER"})

          echo "branch=$(echo "$RESULT" | jq -r '.branch // ""')" >> "$GITHUB_OUTPUT"
          echo "pr_number=$(echo "$RESULT" | jq -r '.prNumber // ""')" >> "$GITHUB_OUTPUT"
          { echo 'task<<EOF'; echo "$RESULT" | jq -r '.task // ""'; echo; echo 'EOF'; } >> "$GITHUB_OUTPUT"

      - name: Run Kilo Code
        env:
          KILO_PROVIDER: kilocode
          KILO_PROVIDER_TYPE: kilocode
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
          KILOCODE_TOKEN: ${{ secrets.KILO_API_KEY }}
          KILOCODE_MODEL: x-ai/grok-code-fast-1
          # KILOCODE_MODEL: minimax/minimax-m2.1:free
          KILO_TELEMETRY_DEBUG: false
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          TASK=$(cat <<'EOF' | tr -d '\n'
          ${{ steps.ctx.outputs.task }}
          EOF
          )
          gha_agent run-kilocode --auto --timeout 2000 --task "$TASK"

      - name: Fix PR body newlines
        if: steps.identifiers.outputs.pr_number != ''
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
          PR_NUMBER: ${{ steps.identifiers.outputs.pr_number }}
        run: gha_agent fix-pr-body --pr-number "$PR_NUMBER"

      - name: Create PR if needed
        id: create_pr
        if: steps.identifiers.outputs.pr_number == ''
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
          KILOCODE_API_KEY: ${{ secrets.KILO_API_KEY }}
        run: |
          ISSUE_NUMBER=${{ steps.identifiers.outputs.issue_number }}
          BRANCH_NAME=${{ steps.branch.outputs.name }}

          RESULT=$(gha_agent create-pr --issue-number "$ISSUE_NUMBER" --branch-name "$BRANCH_NAME")
          echo "pr_number=$(echo "$RESULT" | jq -r '.prNumber // ""')" >> $GITHUB_OUTPUT
